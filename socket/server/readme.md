# socket server说明

## git初始版本为0.5beta

## 使用方法

### TCP启动方法

1. 启动server函数，调用main函数，打开静默函数。
2. 静默函数启动TCP服务器。
3. TCP函数静默后台监测客户端连接。
4. TCP函数监测根据心跳函数循环检测客户端连接。

### UDP调用方法

1. 调用 `_udpControl()` ，返回UDP线程对象（非守护进程 `setDaemon(Fasle)` ），使用 `.start()` 调用。
2. 当在外部调用时（调用模式）需要传入自定义**类对象**或继承 `UdpInfo` ：

    - 当使用自定义类对象时，必须包含如下3个函数（函数名不可发生改变）并且返回值要不可改变：

      ```python
        def ipList():
            # need list
            return []

        def disCommands():
            # need dict
            return {}

        def key():
            # need str
            return ''
      ```

3. 指定参数清洗通过后，函数会将信息上传至redis，并下发任务编号。
4. 当调用UDP时，函数会自动判断当前指定的地址是否存活并反馈下发结果信息。**请注意：如果客户端离线，UDP依然会发送信息，但客户端无法接受。UDP并不会因为客户端离线而等待客户端上线后重新发送。**
5. 下发任务编号后，客户端根据任务编号查找redis执行任务。

## 更新日志

### **0.7 16 Mar. 2021 Beta**

**1. 更新报文识别函数。**

- 详细见 `ant socket 传输手册` 。

**2. 增加日志模块。**

**3. 合并通用函数。**

**4. 其他测试情况。**

- redis命令下发 - 通过。
- cmd命令下发 - 通过。
- redis报文协议传输分析 - 通过。
- redis信息更新 - 通过。
- 日志记录 - 通过。

### **0.61 8 Mar. 2021 Beta**

**1. ADH56信息识别与入库。**

- 新增客户端计算机名称，MAC地址，IPV4信息登记redis。IPV4存入方式为LIST。

**2. 离线信息redis删除。**

- 当设备离线后删除相关信息，根据JSON提供字段。

**3.任务信息监测函数解耦。**

- 新增ADH27函数，功能为处理任务报文（解耦）。

**4.报文处理。**

- 所有发送报文添加识别机制，必须携带代号，否则识别为异常数据。

### **0.6 3 Mar. 2021 Beta**

**1. 增加子类函数（功能函数）。**

- `ADH56()` 接收系统信息。

**2. 优化代码。**

- 当下发所有客户端之前，检查客户端是否存活。
- 合并代码，提出以下函数至上级目录新文件。
  - `ChangeRedis()`
  - `PrettyCode()`
    - `loadingConfigJson()`
    - `prettyPrint()`
- 修改TCP IP绑定时的配置，从原先源码固定改至JSON文件读取。

### **0.5 3 Mar. 2021 Beta**

**1. 增加redis储存方法。**

- 增加redis储存模型。
  - 目前任务:      hash -> client - task
  - 已完成任务:    hash -> client - taskList
                  list -> task
- 增加客户端发送报文规范（清洗规范）。
- redis出入库规范：
  - 完成任务：旧任务表里没有，新任务表有，就添加（已完成）。
  - 未完成任务：旧任务表里有，新任务表没有，就删除（已完成）。
- 增加整合函数，根据传入参数决定是调度未完成任务或完成任务。

### **0.4Beta 25 Feb. 2021**

**1. 修改调度（线程）函数。**

- 主函数启动时，只会启动静默类型函数（TCP）。
- 根据调用次数划分为静默类型和常用类型两种函数，当使用常用函数时（类似UDP），可以在外部通过函数名多次调用来使用。
- 当调用每个功能函数时，都会创建一个进程来完成其功能。

**2. 解耦函数。**

- 调度函数解耦，静默函数与常用函数不会在放在一个统一调度函数的逻辑块内。
- 下发函数解耦。
  - TCP和UDP只有当在调用时才会创建TCP或UDP的socket对象，
  - 当用户调用UDP函数时，参数根据特定类（5）传入至UDP函数，由UDP主函数内部进行逻辑判断（数据处理）。取消了原先数据传入__init__初始化函数，可以重复调用。

**3. 增加守护进程函数。**

- 守护进程根据静默函数字典，持续扫描静默函数，如果发现字典中的函数离线，尝试自动重启。

**4. 增加主机存活检测函数。**

- 根据传入字典的指定主机，去检测该主机当前是否在线。

**5. 增加UDP传送数据格式规范及清洗逻辑。**

- 当使用UDP下发函数时，使用指定下发模式传入所需参数时，制定传入数据格式规范。
- 传入参数规范：
  - 传入：类。
  - 类：3个函数。
    - IP: ipList()
    - 调度命令任务集: disCommands()
    - 任务集名: key()

</br>

### **0.3Beta 22 Feb. 2021**

**1. 增加多重UDP下发模式功能。**

- 下发方式。

  - 控制台下发。
  - 直接运行程序，在控制台能输入下发指令。一次只能下发一条指令。
  - 调用下发。
        - 通过外部调用传入任务字典。根据字典是否为空（标识符）进行判断，使用调用下发，函数将任务字典（任务命令: 优先级）上传至redis中，并根据任务名（key）来区分。上传完毕后返回key值用来作为开始任务的标记符。
        - 调用下发模式不会直接全部下发指令。下发顺序为：
            1. 上传redis指令
            2. 发送开始标识符
            3. 客户端接收到标识符读取redis中的命令开始执行

- 下发主机选择。
  - 根据不同的决定选择下发的主机：
        1. 所有存活主机。
        2. 指定主机。
  - 根据传入参数数据来决定下发主机。

- 控制台下发只能单条，调用主机能下发单条和多条。
- 调用模式根据传入参数决定功能。

</br>

### **0.2Beta 19 Feb. 2021**

**1. 异常处理。**

- TCP SERVER超时设定。当CLIENT在指定时间内没有发送成功存活包后，SERVER断开该连接并判定为掉线。（避免当客户端掉线时，服务器一直等待心跳包造成阻塞）

**2. UDP指令发送函数。**

- 修改UDP下发主机目录，根据redis存活目录进行下发。

**3. 其他。**

- 增加相关运行信息提示。

</br>

### **0.1Beta 6 Feb. 2021**

**1. 基础TCP心跳监测接收。**

- 心跳监测接收客户端发送的 “keepAlive” 包确认客户端存活。
- 判断发送内容是否为空决定该客户端是否已经断开。
- 粘包处理。根据报文头接收4个字段循环取出报文体，避免TCP粘包处理。

**2. 基础UDP指令发送。**

- 根据json文件下发指定的ip地址指令。
- 输入exit()退出udp服务器。

**3. redis根据心跳监测对存活ip进行记录与删除。**

- 根据json文件连接redis服务器。（连接函数）。
- 自定义redis set函数。
- 返回redis对象，调用此对象能够直接使用redis库默认函数。

**4. 线程调度。**

- TCP与UDP两个服务器使用线程调度。

**5. 初始化文件读取。**

</br>
